#!/bin/bash

source $HOME/.config/backup/config

notify_backup () {
	notify-send -i drive-multidisk "$1"
}

case "$1" in
	abort | cancel | end | exit | halt | kill | quit | stop | term | terminate )
		if [ -s $pidfile ]; then
			kill $(cat $pidfile)
		fi
		exit 0
	;;
esac

# make sure process is not already running
if [ -e $pidfile ]; then
	if kill -0 &>1 > /dev/null $(cat $pidfile); then
		notify_backup "A backup is already running!"
		exit 1
	else
		rm $pidfile
	fi
fi
echo $$ > $pidfile

cleanup () {
	[ $? -eq 0 ] && notify_backup "Backup finished"
	echo $? >> $logfile
	rm $pidfile
	exit $?
}
interrupted () {
	kill $rsync_pid
	notify_backup "Backup cancelled"
	exit 1
}

trap cleanup EXIT
trap interrupted TERM INT SIGTERM SIGINT

notify_backup "Backup starting"
rsync -avW --no-p --exclude-from=$excludelist $addr_src $addr_dest &> $logfile &
rsync_pid=$!
wait
