#!/usr/bin/env bash

# Elevate script
if (($EUID != 0)); then
	if [ -t 0 ]; then
		sudo -H "$0" "$@"
	else
		sudo -AH "$0" "$@"
	fi
	exit
fi


# Notification wrapper to de-escalate command
notify_update () {
	if [ -t 0 ]; then
		echo $1
	else
		sudo -u reese dunstify -i software-update-available-symbolic -p "$1"
	fi
}


update_apt () {
	apt update
	apt upgrade -y
	apt autoremove -y
	apt install -f
}

update_npm () {
	npm update -g
	npm install -g electron --unsafe-perm=true # electron is stupid
	npm install -g npm
}

update_pip () {
	pip3 list --outdated --format=freeze | grep -v '^\-e' | cut -d = -f 1  | xargs -n1 pip3 install -U
	sudo -u reese pip3 list --outdated --user --format=freeze | grep -v '^\-e' | cut -d = -f 1  | xargs -n1 sudo -u reese pip3 install -U --user
}

update_omf () {
	sudo -u reese fish -c "omf update"
}


# Parse arguments
do_update_apt=false
do_update_npm=false
do_update_pip=false
do_update_omf=false

if [ $# -eq 0 ]; then
	do_update_apt=true
	do_update_npm=true
	do_update_pip=true
	do_update_omf=true
else
	while(($#)); do
		case "$1" in
			apt)
				do_update_apt=true
				shift
				;;
			npm)
				do_update_npm=true
				shift
				;;
			pip)
				do_update_pip=true
				shift
				;;
			omf)
				do_update_omf=true
				shift
				;;
		esac
	done
fi

notify_update "Fetching updates..."

$do_update_apt && update_apt &
$do_update_npm && update_npm &
$do_update_pip && update_pip &
$do_update_omf && update_omf &

wait
notify_update "Updates complete."
